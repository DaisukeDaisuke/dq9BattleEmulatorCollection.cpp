## dq9BattleEmulatorCollection.cpp

dq9のRTA用バトルエミュレーター  


## how to build
Please build with [jetBrains clion](https://www.jetbrains.com/ja-jp/clion/) using cmake, ninja, or mingw.  
[jetBrains clion](https://www.jetbrains.com/ja-jp/clion/)のデフォルト設定(mingw)向けで作られています。なのでclionとかいうペイウォールさえ突破できればビルドできます。  

[稀に不安定なバージョンを無料で使えたりする](https://www.jetbrains.com/ja-jp/clion/nextversion/)ので、それでビルドするのはありかもしれません。ストレージめっちゃ食うけど

また、erugiosu以降では、様々な機能を取り込みつつ、c++17水準で書かれており、幅広い環境、例えば、virtual studio(cmakeサポート)
、msbuild(with cmake)での静的ビルドに対応しています。  
このリポジトリ全体の制約として、windows.hは使ってません。なのでLinux等でもビルドできると思いますが、Linuxのg++についてはいまのところ正式にはサポートしていません。

本番exeのビルドについては、Github Actionsでビルドすることになっています。  
一部の配布物はわざと配布してないことがあるので、その場合は(Github Actionsを他人のリポジトリで使う方法を知っていれば)
、自由にクラウド、またはローカルでビルドできます。  
コマンドラインでのビルド方法は各ブランチのワークフローファイル見てください。

## vs22でデバック時引数を追加する方法

`./.vs/launch.vs.json`をエクスプローラーで表示設定にして直接編集するか  
`デバック > [rbe_multi]デバックおよび機能の設定`でlaunch.vs.jsonを開き、  
デフォルトで生成されているjsonに下記の位置でargsカラムを追加します。
そしてctrl+Sで保存してcmakeを再読み込みすれば、argc付きで起動するようになります

```json
{
  "version": "0.2.1",
  "defaults": {},
  "configurations": [
    {
      "type": "default",
      "project": "CMakeLists.txt",
      "projectTarget": "rbe_multi.exe",
      "name": "rbe_multi.exe",
      "args": ["0", "2", "26", "26", "r", "21", "32", "r", "b", "b", "22", "35", "b", "23", "36", "0", "22", "h"]
    }
  ]
}
```

## バージョンについて

dq9BattleEmulatorCollection.cppでは、歴史的な理由により、各ブランチごとに搭載している最適化機能、品質改善がことなります。  
以下、ブランチごとに搭載している機能について紹介します

## yo2

一人旅RTA用イシュダルバトルエミュ(リリースバイナリではv0としています)

- 最低限の最適化技術が搭載されています。
- 探索アルゴリズムは各行動を1回だけ変更するという単純なものであり、ここ数年にリリースされたcpuでは150msしかかかりません。
- ブルートフォースはこの時点でstd::stringを排除してバトルエミュ本体に探索コードが埋め込まれている方式を採用しており、ブルートフォースもそこそこ高速です。

## erugiosu2

一人旅RTA用エルギオス第2形態バトルエミュ(リリースバイナリではv1としています)

- 上の最適化と一緒に、「バトルエミュを指定したターンだけ実行し、それ以降は中断して親関数にもどる」という革新的な機能がやっと実装されました。
- このバージョンからは一定の後方互換性があるため、有益な最適化はバックポートされています。
- ここから探索アルゴリズムが書き直され、アルゴリズムが組み合わせ最適化を行い、行動を指定してくるという方式になりました。
- このアルゴリズムはたまたま出来た産物であるにもかかわらず、判断力0、判断力1ではパラメータ設定によってはそこそこ賢いけど完全に不審者な選択肢を提示します。
- ただし、探索アルゴリズムはまだ最適化の余地はあると考えています。
- エルギオスバトルエミュは映像認識とセットで操作します。

フロントエンドプログラムはc#の[dq9RTAVideoRecognitions.csharp](https://github.com/DaisukeDaisuke/dq9RTAVideoRecognitions.csharp)
V2が担当します。
- バックエンドプログラムはこのリポジトリが担当します

## bilyouma

一人旅用病魔バトルエミュ(リリースバイナリではv5としています)

- バトルエミュのパフォーマンスコアである万ターン/秒の測定を開始しました
- ついにマルチスレッド対応(探索アルゴリズムのみ)が導入され、最新のcpuで4コアを使えば、探索アルゴリズムなのに1460万ターン/秒が出るようになりました。
- また、stdへの依存をメイン処理から排除し、exe解析時に読みやすくなるような最適化も大量に取り込んでいます。
- 複数のexeの同時生成を始めました。これにより、複数のステータスのバトルエミュをブランチを分断せずに同一コードで対応することが可能になりました  
- このブランチは基本的にzilyadamaと連動して動いています。
- 要望により、入力方式は手動入力のみ対応しています。結果的にA100のような入力が採用されました。

## zilyadama

一人旅ジャダーマ向けバトルエミュ(リリースバイナリではv6としています)  

- バグパッチは上と連動してるので基本的に変わりません。

## nusisama1

一人旅用ぬしさま1バトルエミュ(リリースバイナリではv3としています)

- 病魔のぬしさま対応版かつ、様々な機能オプトアウト版おそらく探索アルゴリズム4コアマルチ1600万ターン/sぐらいでる
- 7時間で作った

## yo2_v4_test

イシュダルバトルエミュが今の探索アルゴリズムでどれだけ賢さ、性能出るかのテスト用移植  
結果、性能がいまいちだったので没に

## Q&A

### Q: ウイルス対策ソフトに検知されたんだけど

もし使いたいだけの場合、mingw版の場合msbuild版、msbuild版の場合mingw版(非公開)を試してみてください。  
一度検知されたexeは、exe名、ダウンロードurl、exeアイコンなどが同じであれば再検知されるので、再ビルドは必須です。  
とくに、一部のバージョンではイースターエッグを搭載しているので、そのexeが検知されればそのイースターエッグがウイルス対策ソフトに登録される可能性があります。  
開発環境のワークスペースが検知された場合はウイルス対策ソフトの除外設定に登録してください。  
これらのc++プログラムはcpuこそ使いますが、悪意のあるコードはmainには混ざってません。  
おそらく、エルギオス以降は静的リンクしてるので外部モジュールに対する検知だと思います

### Q: vs22のデバックで実行すると非常に遅いんだけどなんで
A: AddressSanitizer(スタックオーバーフローなどの検知)が有効になってるから  
  
### Q: エルギオスバトルエミュを起動しても何も起きないんだけど
A: bから始まる専用のフォーマット入れないと動きません。  
映像認識から機械的に生成された専用のフォーマットを処理するように設計されているため、手動でこの形式を構築するのは無理です。  

### Q: なんでバトルエミュごとに入力ルールが違うの
A: 約数百万通りからの総当たりで特定できないから  

#### エルギオスバトルエミュ
映像認識が認識結果を元に入力を機械的に生成します。  
これは一度起動してから標準入力に入力します。引数に渡すと無視されます。  
スペーサーは`-`です  
前から、コマンド、時間、敵の行動内部id、味方の行動id、ダメージ、スペーサーと続きます。  
```
b 7 55 11 5 5 1 2 1 12 9 8 5 1 2-30 31 35 35 30-53 14 8 12 225 1 54 0 1-
```
#### 病魔バトルエミュ
発生したイベントをすべて手動で引数に入力します  
rはルカナン、bはボミオス、aはあまいいき、hは特薬草です。  
0ダメージ攻撃も入力します。
```
rbe_multi_lv18_sp34.exe 0 3 54 a85 9 a a26 10 10 10 b a26
```

#### イシュダルバトルエミュ
発生したダメージをすべて引数に入力します。  
0ダメージは省略します。  
```
0 3 48 18 10 9 18 10 17 17 18 10 h 
```

### Q: msbuild版とmingw版(非公開)で出力が違うんだけど(特にイシュダルバトルエミュ)  
記録動画と比較して一致しないこと、ありますよね。   
stdの優先度付きキューが同じ優先度のものがあった場合、どれを最初に取り出すか、というstdの実装的な違いにより発生します。    
イシュダルバトルエミュはまだmingw版を使う風習があるので、比較するならmingw版(clion)をビルドしないと一致しません    
エルギオス以降では、物量によってかき消されるので基本発生しにくいです。    

### Q: mingw版のexeが3mbとかになるんだけど
A: `CMakeLists.txt`の`CMAKE_CXX_FLAGS`に`-s`フラグつけるとデバックシンボルが埋め込めれなくなりデバックが不可能になる代わりに2mbぐらい減ります。  
devenv(vs22)でビルドしたものについてしりません。  
Github Actionsでビルドしたものを使ってください(エルギオス以降であれば静的リンクで400kbなので)。    
```cmake
if(MINGW)
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -O3 -march=x86-64 -mtune=generic -ffunction-sections -fdata-sections -s")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -march=x86-64 -mtune=generic -ffunction-sections -fdata-sections -s")
    set(CMAKE_EXE_LINKER_FLAGS "-static -Wl,--gc-sections")
elseif(MSVC)
```

### msbuild版ビルドに付属してるpdbファイルってなに？

msbuildが生成するデバッグシンボルです。  
これがあると第三者が後からexe解析するときに圧倒的に楽になります。  
ウイルス検知されたときのために、一緒にpdbをデータベースに送信してくれればウイルスではない証明にもなる可能性をこめて生成、付属させています。  

## branches
ブランチ紹介

### bilyouma

9一人旅用 病魔パンデルム用バトルエミュ。対応するレベルなど、詳細は後日記述します。   
マルチスレッド対応(4コア)
や、ボトルネックの緩和策の実装、AddressSanitizerでのバグチェックなど、新機能を大量に取り入れています。   
いまのところ入力文字列(引数)は未定です。

### erugiosu
エルギオス僧侶レベル50のグリーンタイツバトルエミュです。debug.hのフラグが全て折られている場合、対話型プログラムとして起動します。  
モードは、ブルートフォースリクエストのbオプションとプログラムを終了するqオプションのみです。  
```
b 7 42 15 5 1 2 2 15 17 12 10 9 9 8 41-30 31 30 35 35-1 5 9 54 237 245 0-
```
プログラムは+-30秒に相当する3000万シードを4秒で検索し、探索アルゴリズムは300候補を1秒間で調べます。非常に高速です。
このプログラムは7時間のような長期実行に対応しました。

### yo2
イシュダルの旅芸人レベル11 一人旅RTA装備用バトルエミュです。このブランチは最新のバグパッチが適応されています。  
デフォルトで総当たりモードになってたりなかったりします。総当たりモードにするには、debug.hのフラグを全て折ってください。   
i7 6700kでは総当たり(+-1.5秒)に0.3秒かかります。最新のcpuだと0.15秒程度しかかからないらしいです(最適化で爆速化に成功した)  

#### 引数解説
```
0 3 48 18 10 9 18 10 17 17 18 10 h 
```

- 1個目: X時間 (戦闘開始時の画面がひねるエフェクトが発生した時のリアルタイムタイマー、ライブスピリットとの誤差-15秒+-1秒想定です。)  
- 2個目: Y分  
- 3個目: Z秒  
- 4個目以降: ダメージ値。0ダメージの場合入力せず、ホイミはhです。

※2時間15分を越えるとバグって絶対に特定できない仕様があります。どちらかというとバグですが、あんまり影響ないのであえて放置します。  


### Q
VS版を実行しようとすると`VCRUNTIME140.dll`がなんちゃらって言われて動かないんだけど

### A
これを入れてください。virtual studio 22(MsBuild)でビルドしたc++実行可能バイナリはこれないと動きません。
mingw版(非公開)を実行する場合不要です。
```
https://aka.ms/vs/17/release/vc_redist.x64.exe
```


https://github.com/DaisukeDaisuke/dq9BattleEmulatorCollection.cpp/tree/yo2


### buru_BruteForce

ブルドーガのバトルエミュレーターです。yo2では修正されたバグを何個か抱えてますが、動作に問題ないので放置してます。  
レベル1討伐とかで役に立つのに完全にリアルタイムタイマーとの誤差特定用になってます。  

https://github.com/DaisukeDaisuke/dq9BattleEmulatorCollection.cpp/tree/buru_BruteForce


### 追加要件

- 許可なく自作発言禁止(自作発言は一部の人のみ許可しています)
- これを使用したことによる実行したコンピーターやds、またはバグなどのミスによる不利益、損傷、または意図した通りに動作するかどうかについては一切保証せず、現状のままでの提供になります。これはバグ報告を制限するものではなく、自由にissueで報告することができます。
  - また、mingw版は悪意のあるプログラムと誤検知されるため配布する予定はありません。フォークしてvs版をGithub Actionsでビルドするか、クローンしてclionを使って各自でビルドしてください。
  - exeをVenusTotalにかけるなど、万全を期していますが、vs版や、mingw版(非公開)を実行した場合、プログラムに悪意のあるプログラムが混じっている可能性があることに同意することとします。
